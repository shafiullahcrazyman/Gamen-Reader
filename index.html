<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Gamen Reader by Shafiullah</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" href="icon.png">
    <meta name="theme-color" content="#1c1b20">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Gamen Reader">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* === THEME VARIABLES === */
        :root {
            --bg-body: #1C1B1F;
            --bg-surface: #2A282E;
            --bg-nav: #333138;
            --text-main: #E6E1E5;
            --text-muted: #9ca3af;
            --border-color: rgba(55, 65, 81, 0.5);
            --btn-copy-bg: #7c3aed; /* violet-600 */
            --btn-copy-hover: #6d28d9; /* violet-700 */
            
            /* === INTERACTION VARIABLES === */
            --ease-material: cubic-bezier(0.2, 0.0, 0, 1.0); /* Emphasized Decelerate */
            --ease-spring: cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Subtle Bounce */
        }

        [data-theme="light"] {
            --bg-body: #FDFBFF;
            --bg-surface: #F2F0F4;
            --bg-nav: #FFFFFF;
            --text-main: #1C1B1F;
            --text-muted: #4B5563;
            --border-color: #E5E7EB;
            --btn-copy-bg: #7c3aed;
            --btn-copy-hover: #6d28d9;
        }

        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent; 
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            transition: background-color 0.4s var(--ease-material), color 0.4s var(--ease-material);
        }

        .theme-bg-body { background-color: var(--bg-body); }
        .theme-bg-surface { background-color: var(--bg-surface); }
        .theme-bg-nav { background-color: var(--bg-nav); }
        .theme-text-main { color: var(--text-main); }
        .theme-text-muted { color: var(--text-muted); }
        .theme-border { border-color: var(--border-color); }

        #story-input::-webkit-scrollbar { display: none; }
        #story-input { -ms-overflow-style: none; scrollbar-width: none; }

        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            padding: 1.5rem;
            background-color: var(--bg-surface);
            border-radius: 1.5rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            border: 1px solid var(--border-color);
            text-align: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s var(--ease-material), transform 0.3s var(--ease-spring);
        }
        .message-box:not(.hidden) {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
            pointer-events: auto;
        }

        #library-list::-webkit-scrollbar { width: 6px; }
        #library-list::-webkit-scrollbar-thumb { background-color: #49454F; border-radius: 10px; }
        #library-list { scrollbar-width: thin; scrollbar-color: #49454F transparent; }

        .eye-slash { display: none; }
        .eye-open { display: block; }
        #toggle-meaning-button.toggled .eye-slash { display: block; }
        #toggle-meaning-button.toggled .eye-open { display: none; }

        /* === SMOOTH MODAL TRANSITIONS === */
        #settings-modal, #video-modal {
            transition: opacity 0.3s var(--ease-material), transform 0.3s var(--ease-material);
            opacity: 0;
            pointer-events: none;
            border-radius: 0px; 
            background-color: var(--bg-body);
            transform: scale(0.96); 
        }

        #settings-modal.active, #video-modal.active {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
        }

        @media (min-width: 768px) {
            #settings-modal, #video-modal {
                left: 50%;
                top: 50%;
                transform: translate(-50%, -48%) scale(0.96); 
                width: 100%;
                max-width: 600px;
                height: auto;
                max-height: 90%;
                border-radius: 32px;
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
                border: 1px solid var(--border-color);
            }
            #settings-modal.active, #video-modal.active {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        /* === INTERACTIVE ELEMENTS === */
        .ripple-btn {
            position: relative;
            overflow: hidden;
            transform: translateZ(0); 
            transition: transform 0.1s var(--ease-material), background-color 0.2s linear, box-shadow 0.2s var(--ease-material);
        }
        .ripple-btn:active {
            transform: scale(0.96);
        }

        .ripple {
            position: absolute;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.15); 
            transform: scale(0);
            animation: ripple-anim 0.6s linear;
            pointer-events: none;
        }
        [data-theme="light"] .ripple {
            background-color: rgba(0, 0, 0, 0.1); 
        }

        @keyframes ripple-anim {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        /* Custom Press Animation for the Eye Button (Squish instead of Ripple) */
        #toggle-meaning-button {
            transition: transform 0.15s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        }
        #toggle-meaning-button:active {
            transform: translateY(-50%) scale(0.85) !important;
        }

        @keyframes fadeSlideUp {
            from {
                opacity: 0;
                transform: translateY(15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .library-item {
            opacity: 0; 
            animation: fadeSlideUp 0.5s var(--ease-material) forwards;
        }

        .theme-card {
            transition: background-color 0.2s, border-color 0.2s, transform 0.1s var(--ease-material);
            border: 1px solid transparent;
            position: relative;
            overflow: hidden;
        }
        .theme-card:active {
            transform: scale(0.97);
        }
        
        .theme-card[data-selected="true"] {
            background-color: rgba(124, 58, 237, 0.12); 
            border-color: #7c3aed; 
        }
        .theme-card[data-selected="true"] .theme-icon {
            color: #7c3aed;
            background-color: #ede9fe; 
        }
        [data-theme="dark"] .theme-card[data-selected="true"] .theme-icon {
            background-color: #4c1d95; 
            color: #d8b4fe;
        }

        .btn-copy-default { background-color: var(--btn-copy-bg); color: white; }
        .btn-copy-success { background-color: #16a34a !important; color: white !important; }
    </style>
</head>
<body class="theme-bg-body theme-text-main">

    <!-- === FULL SCREEN VIDEO SHEET === -->
    <div id="video-modal" class="fixed inset-0 z-[150] flex flex-col h-full w-full theme-bg-body">
        <div class="px-6 pt-6 pb-6 flex items-center justify-between">
            <h2 class="text-4xl md:text-5xl font-bold theme-text-main tracking-tight">Tutorial</h2>
            <button id="close-video-button" class="ripple-btn p-3 rounded-full theme-text-main hover:bg-gray-700/20 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        
        <div class="flex-grow flex flex-col px-6">
            <div class="w-full relative rounded-[24px] overflow-hidden shadow-2xl border theme-border bg-black">
                 <div id="video-container" class="w-full">
                    <!-- Iframe injected here via JS -->
                 </div>
            </div>
        </div>
    </div>

    <!-- === FULL SCREEN SETTINGS SHEET === -->
    <div id="settings-modal" class="fixed inset-0 z-[100] flex flex-col h-full w-full theme-bg-body">
        <div class="px-6 pt-6 pb-6 flex items-center justify-between">
            <div>
                <h2 class="text-4xl md:text-5xl font-bold theme-text-main tracking-tight">Settings</h2>
            </div>
            <button id="close-settings-button" class="ripple-btn p-3 rounded-full theme-text-main hover:bg-gray-700/20 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        
        <div class="px-6 flex-grow overflow-y-auto">
            <div class="mb-10">
                <h3 class="text-sm font-bold text-violet-500 uppercase tracking-widest mb-6 ml-1">Appearance</h3>
                
                <div class="grid grid-cols-1 gap-4">
                    <!-- Light Mode Card -->
                    <button onclick="setTheme('light')" id="btn-theme-light" class="theme-card ripple-btn w-full text-left p-5 rounded-[24px] theme-bg-surface flex items-center justify-between group">
                        <div class="flex items-center pointer-events-none">
                            <div class="theme-icon bg-gray-500/10 p-3 rounded-full mr-5 text-gray-500 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41-1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
                            </div>
                            <div>
                                <span class="text-xl font-semibold theme-text-main block">Light Mode</span>
                                <span class="text-sm theme-text-muted">Clean and bright</span>
                            </div>
                        </div>
                        <div class="radio-circle w-6 h-6 rounded-full border-2 border-gray-400/50 flex items-center justify-center transition-colors pointer-events-none">
                            <div class="w-3 h-3 rounded-full bg-violet-600 opacity-0 transition-opacity"></div>
                        </div>
                    </button>
                    
                    <!-- Dark Mode Card -->
                    <button onclick="setTheme('dark')" id="btn-theme-dark" class="theme-card ripple-btn w-full text-left p-5 rounded-[24px] theme-bg-surface flex items-center justify-between group">
                        <div class="flex items-center pointer-events-none">
                            <div class="theme-icon bg-gray-500/10 p-3 rounded-full mr-5 text-gray-400 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
                            </div>
                            <div>
                                <span class="text-xl font-semibold theme-text-main block">Dark Mode</span>
                                <span class="text-sm theme-text-muted">Easy on the eyes</span>
                            </div>
                        </div>
                        <div class="radio-circle w-6 h-6 rounded-full border-2 border-gray-400/50 flex items-center justify-center transition-colors pointer-events-none">
                            <div class="w-3 h-3 rounded-full bg-violet-600 opacity-0 transition-opacity"></div>
                        </div>
                    </button>

                    <!-- System Mode Card -->
                    <button onclick="setTheme('system')" id="btn-theme-system" class="theme-card ripple-btn w-full text-left p-5 rounded-[24px] theme-bg-surface flex items-center justify-between group">
                        <div class="flex items-center pointer-events-none">
                            <div class="theme-icon bg-gray-500/10 p-3 rounded-full mr-5 text-gray-400 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="14" x="2" y="3" rx="2"/><line x1="8" x2="16" y1="21" y2="21"/><line x1="12" x2="12" y1="17" y2="21"/></svg>
                            </div>
                            <div>
                                <span class="text-xl font-semibold theme-text-main block">System Default</span>
                                <span class="text-sm theme-text-muted">Matches device settings</span>
                            </div>
                        </div>
                        <div class="radio-circle w-6 h-6 rounded-full border-2 border-gray-400/50 flex items-center justify-center transition-colors pointer-events-none">
                            <div class="w-3 h-3 rounded-full bg-violet-600 opacity-0 transition-opacity"></div>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="flex-grow flex items-center justify-center w-full h-full relative">
        
        <!-- === HOMEPAGE (LIBRARY) === -->
        <div id="home-container" class="flex flex-col w-full h-full p-6 md:p-8 max-w-3xl mx-auto relative">
            
            <div class="flex items-center justify-between mb-8 w-full relative">
                <!-- Header Pill -->
                <div class="bg-violet-600 text-white pl-5 pr-1 py-1 rounded-full flex items-center shadow-lg cursor-default select-none">
                    <span class="text-2xl font-bold tracking-tight mr-3">Gamen Reader</span>
                    
                    <!-- CLICKABLE VIDEO ICON -->
                    <button id="tutorial-button" class="ripple-btn bg-violet-800/50 rounded-full w-8 h-8 flex items-center justify-center hover:bg-violet-700 transition-all duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-white ml-0.5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>

                <button id="menu-button" class="ripple-btn theme-text-muted hover:text-violet-500 transition-colors p-2 rounded-full active:bg-gray-800/20">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16m-7 6h7" />
                    </svg>
                </button>
            </div>
            
            <div id="library-list" class="flex-grow overflow-y-auto space-y-4 pb-24">
                <!-- List Items Injected Here -->
            </div>

            <!-- Empty State -->
            <div id="empty-state" class="hidden flex flex-col items-center justify-center absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full px-4 select-none">
                <div class="bg-violet-600/10 p-6 rounded-full mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-violet-500/60" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                    </svg>
                </div>
                <p class="text-xl font-semibold theme-text-muted mb-1">No stories yet</p>
                <p class="text-sm theme-text-muted opacity-80">Tap the <span class="font-bold text-violet-500">+</span> button to add one!</p>
            </div>

            <button id="add-new-button" class="ripple-btn fixed bottom-8 right-8 bg-violet-600 text-white w-14 h-14 rounded-2xl shadow-lg shadow-violet-900/40 flex items-center justify-center hover:bg-violet-700 transition-transform transform z-50">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                </svg>
            </button>
        </div>

        <!-- === INPUT PAGE === -->
        <div id="input-container" class="hidden flex flex-col w-full h-full p-6 md:p-8 absolute top-0 left-0 theme-bg-body z-40">
            <div class="flex items-center justify-between mb-4">
                <button id="cancel-input-button" class="ripple-btn px-2 py-1 rounded-lg theme-text-muted hover:text-violet-500 flex items-center transition-colors">
                    <!-- CHANGED: stroke-width from 2 to 3 for bolder look -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-1 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                    </svg>
                    Back
                </button>
                <h2 class="text-xl font-semibold theme-text-main">Add a new story!</h2>
                <div class="w-10"></div>
            </div>
            
            <textarea id="story-input"
                class="flex-grow w-full p-4 theme-text-main placeholder-gray-500 theme-bg-surface rounded-3xl focus:outline-none focus:ring-2 focus:ring-violet-500/50 transition duration-200 resize-none border theme-border"
                placeholder='Paste your JSON here... '></textarea>
            
            <div class="flex flex-row w-full mt-6 space-x-4">
                <button id="copy-prompt-button"
                    class="ripple-btn flex-1 btn-copy-default py-4 text-lg rounded-l-full font-semibold transition-all duration-200 flex-shrink-0 shadow-lg shadow-violet-900/40">
                    Copy Prompt
                </button>
                <button id="load-button"
                    class="ripple-btn flex-1 bg-violet-600 text-white py-4 text-lg rounded-r-full font-semibold hover:bg-violet-700 transition-all duration-200 shadow-lg shadow-violet-900/40 flex-shrink-0 active:bg-violet-800">
                    Save & Read
                </button>
            </div>
        </div>

        <!-- === READER PAGE === -->
        <div id="reader-content-wrapper" class="flex flex-col items-center justify-center w-full h-full hidden absolute top-0 left-0 theme-bg-body z-50">
            <div id="reader-container" class="w-full h-full flex flex-col justify-center relative">
                <div class="absolute top-0 left-0 p-4 z-50">
                    <button id="back-button" class="ripple-btn p-2 rounded-full theme-text-muted hover:text-violet-500 transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>
                </div>
                <div class="flex-grow flex flex-col justify-center items-center space-y-6 px-4">
                    <div id="reader-japanese-text" class="text-3xl md:text-4xl font-bold text-center leading-tight cursor-pointer theme-text-main hover:text-violet-500 transition-colors select-none">
                    </div>
                    <div id="reader-meaning-container" class="transition-opacity duration-300 w-full max-w-2xl text-center cursor-pointer select-none">
                        <p id="reader-english-text" class="text-lg theme-text-muted hover:text-violet-500 transition-colors"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="navigation-bar" class="fixed bottom-6 left-1/2 -translate-x-1/2 w-full max-w-xs mx-auto hidden z-[60]">
        <div class="relative theme-bg-nav rounded-full flex items-center justify-end shadow-xl p-2 border theme-border">
            <!-- Removed ripple-btn class to stop water drop animation, CSS handles squish -->
            <button id="toggle-meaning-button" class="absolute top-1/2 -translate-y-1/2 -left-1 bg-violet-600 text-white w-16 h-16 rounded-full flex items-center justify-center shadow-lg transition-all duration-200 z-10">
                <svg class="h-8 w-8 eye-open pointer-events-none" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                <svg class="h-8 w-8 eye-slash pointer-events-none" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.243 4.243l-4.243-4.243" />
                </svg>
            </button>
            <div class="flex items-center space-x-8 pr-6 pl-16">
                <button id="prev-button" class="ripple-btn p-2 rounded-full theme-text-muted hover:text-violet-500 transition-colors duration-200 disabled:opacity-20 disabled:cursor-not-allowed">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <button id="next-button" class="ripple-btn p-2 rounded-full theme-text-muted hover:text-violet-500 transition-colors duration-200 disabled:opacity-20 disabled:cursor-not-allowed">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <div id="message-box" class="message-box hidden">
        <p id="message-text" class="mb-4 text-xl theme-text-main"></p>
        <button id="close-message" class="ripple-btn bg-violet-600 text-white py-2 px-6 rounded-full font-semibold hover:bg-violet-700">OK</button>
    </div>

    <script>
        // DOM Elements
        const storyInput = document.getElementById('story-input');
        const loadButton = document.getElementById('load-button');
        const copyPromptButton = document.getElementById('copy-prompt-button');
        const prevButton = document.getElementById('prev-button');
        const nextButton = document.getElementById('next-button');
        const backButton = document.getElementById('back-button');
        const toggleMeaningButton = document.getElementById('toggle-meaning-button');
        const japaneseText = document.getElementById('reader-japanese-text');
        const englishText = document.getElementById('reader-english-text');
        
        // Views
        const homeContainer = document.getElementById('home-container');
        const inputContainer = document.getElementById('input-container');
        const readerWrapper = document.getElementById('reader-content-wrapper');
        const readerContainer = document.getElementById('reader-container');
        const navigationBar = document.getElementById('navigation-bar');
        const libraryList = document.getElementById('library-list');
        const emptyState = document.getElementById('empty-state');
        
        // Buttons
        const addNewButton = document.getElementById('add-new-button');
        const cancelInputButton = document.getElementById('cancel-input-button');
        const menuButton = document.getElementById('menu-button');
        const settingsModal = document.getElementById('settings-modal');
        const closeSettingsButton = document.getElementById('close-settings-button');
        
        // Video Elements
        const tutorialButton = document.getElementById('tutorial-button');
        const videoModal = document.getElementById('video-modal');
        const videoContainer = document.getElementById('video-container');
        const closeVideoButton = document.getElementById('close-video-button');
        
        const meaningContainer = document.getElementById('reader-meaning-container');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const closeMessageButton = document.getElementById('close-message');

        const promptText = `Generate a short Japanese story for language learners in JSON format.

IMPORTANT OUTPUT RULES:
1) First, output ONLY the JSON data.
2) Format it exactly as JSON and wrap it in a triple-backtick code block labeled json so it’s ready to copy.
3) After the JSON code block ends, output a separate section called "Story Suggestions".
4) The "Story Suggestions" section must NOT be inside the JSON.
5) The JSON must remain valid and unchanged.

JSON STRUCTURE RULES:
• Output ONLY valid JSON inside the code block.
• The result must be an array [ ] of objects.
• Each object must contain exactly two keys: "jp" and "en".

TITLE RULES:
• The FIRST object is the title sentence.
• The title must be very short and simple.
• It should describe the topic of the story.
• It will be shown like a normal sentence in the reader.

JAPANESE ("jp") RULES:
• Use natural, polite Japanese.
• Keep sentences short and beginner friendly.
• Use <ruby>漢字<rt>かな</rt></ruby> for ALL kanji.
• Do NOT use romaji.
• Do NOT use English words.
• Do NOT omit furigana for any kanji.

ENGLISH ("en") RULES:
• Provide a clear and simple English meaning.
• Keep translations natural and easy to understand.

GENERAL RULES:
• Total length must be 6–9 objects (1 title + story sentences).
• Avoid complex grammar.
• Avoid rare or advanced vocabulary.
• Output only valid JSON inside the code block.

After the JSON block, include:

Story Suggestions:
• Suggest exactly 5 new story topics.
• Each topic must be suitable for beginner language learners.
• Keep topics short and clear.
• Do NOT include JSON in this section.
• Do NOT repeat the topic used in the story above.`;
        const videoIframeHTML = `<div style="position:relative; width:100%; height:0px; padding-bottom:100.000%"><iframe allow="fullscreen;autoplay" allowfullscreen height="100%" src="https://streamable.com/e/0nwd8k?autoplay=1" width="100%" style="border:none; width:100%; height:100%; position:absolute; left:0px; top:0px; overflow:hidden;"></iframe></div>`;

        let storyData = [];
        let currentSentenceIndex = 0;
        let isMeaningVisible = true;
        let library = [];

        // --- RIPPLE EFFECT LOGIC (Native Feel) ---
        function createRipple(event) {
            const button = event.currentTarget;
            
            // Don't create ripple if disabled
            if (button.disabled) return;

            const circle = document.createElement("span");
            const diameter = Math.max(button.clientWidth, button.clientHeight);
            const radius = diameter / 2;

            const rect = button.getBoundingClientRect();
            
            circle.style.width = circle.style.height = `${diameter}px`;
            circle.style.left = `${event.clientX - rect.left - radius}px`;
            circle.style.top = `${event.clientY - rect.top - radius}px`;
            circle.classList.add("ripple");

            // Remove existing ripples to keep it clean
            const existingRipple = button.getElementsByClassName("ripple")[0];
            if (existingRipple) {
                existingRipple.remove();
            }

            button.appendChild(circle);
        }

        // --- Initialization ---

        document.addEventListener('DOMContentLoaded', () => {
            loadLibrary();
            renderLibrary();
            initTheme();
            
            // Attach Ripple to all elements with class .ripple-btn
            const rippleButtons = document.querySelectorAll('.ripple-btn');
            rippleButtons.forEach(btn => {
                btn.addEventListener('click', createRipple);
            });
            
            history.replaceState({page: 'home'}, '', '');
            
            window.addEventListener('popstate', (event) => {
                const page = event.state ? event.state.page : 'home';
                renderPage(page);
            });
        });

        // --- Navigation Logic (Router) ---

        function renderPage(page) {
            homeContainer.classList.add('hidden');
            inputContainer.classList.add('hidden');
            readerWrapper.classList.add('hidden');
            navigationBar.classList.add('hidden');
            
            // Handle Modals
            settingsModal.classList.remove('active');
            
            videoModal.classList.remove('active');
            videoContainer.innerHTML = ""; // Stop video playback on close

            if (page === 'home') {
                homeContainer.classList.remove('hidden');
                storyInput.value = ""; 
                // Re-render library to trigger entrance animations
                renderLibrary();
            } 
            else if (page === 'input') {
                inputContainer.classList.remove('hidden');
            } 
            else if (page === 'reader') {
                readerWrapper.classList.remove('hidden');
                navigationBar.classList.remove('hidden');
                renderSentence();
            } 
            else if (page === 'settings') {
                requestAnimationFrame(() => {
                    settingsModal.classList.add('active');
                });
            }
            else if (page === 'video') {
                videoContainer.innerHTML = videoIframeHTML; // Inject video
                requestAnimationFrame(() => {
                    videoModal.classList.add('active');
                });
            }
        }

        function goHome() {
            history.back();
        }

        function goToInput() {
            history.pushState({page: 'input'}, '', '#new');
            renderPage('input');
        }

        function openSettings() {
            history.pushState({page: 'settings'}, '', '#settings');
            renderPage('settings');
        }
        
        function openVideo() {
            history.pushState({page: 'video'}, '', '#tutorial');
            renderPage('video');
        }

        // --- Theme Logic ---

        function initTheme() {
            const savedTheme = localStorage.getItem('gamen-theme');
            let themeToApply = 'system';

            if (savedTheme === 'light' || savedTheme === 'dark') {
                themeToApply = savedTheme;
                document.documentElement.setAttribute('data-theme', savedTheme);
            } else {
                applySystemTheme();
            }
            
            updateThemeUI(savedTheme || 'system');
        }

        function applySystemTheme() {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) {
                document.documentElement.setAttribute('data-theme', 'light');
            } else {
                document.documentElement.removeAttribute('data-theme');
            }
        }

        function setTheme(mode) {
            if (mode === 'system') {
                localStorage.removeItem('gamen-theme');
                applySystemTheme();
            } else {
                localStorage.setItem('gamen-theme', mode);
                document.documentElement.setAttribute('data-theme', mode);
            }
            
            updateThemeUI(mode);
            history.back();
        }

        function updateThemeUI(activeMode) {
            // Reset all cards
            ['light', 'dark', 'system'].forEach(mode => {
                const btn = document.getElementById(`btn-theme-${mode}`);
                if(btn) {
                    btn.setAttribute('data-selected', 'false');
                    // Hide radio dot
                    btn.querySelector('.radio-circle div').classList.remove('opacity-100');
                    btn.querySelector('.radio-circle div').classList.add('opacity-0');
                    // Reset border color of radio circle
                    btn.querySelector('.radio-circle').classList.remove('border-violet-500');
                    btn.querySelector('.radio-circle').classList.add('border-gray-400/50');
                }
            });

            // Highlight active card
            const activeBtn = document.getElementById(`btn-theme-${activeMode}`);
            if(activeBtn) {
                activeBtn.setAttribute('data-selected', 'true');
                // Show radio dot
                activeBtn.querySelector('.radio-circle div').classList.remove('opacity-0');
                activeBtn.querySelector('.radio-circle div').classList.add('opacity-100');
                // Color radio circle
                activeBtn.querySelector('.radio-circle').classList.remove('border-gray-400/50');
                activeBtn.querySelector('.radio-circle').classList.add('border-violet-500');
            }
        }

        menuButton.addEventListener('click', openSettings);
        closeSettingsButton.addEventListener('click', () => history.back());
        
        // Video Listeners
        tutorialButton.addEventListener('click', openVideo);
        closeVideoButton.addEventListener('click', () => history.back());

        // --- Library Logic ---

        function loadLibrary() {
            const stored = localStorage.getItem('gamen-library');
            if (stored) {
                try {
                    library = JSON.parse(stored);
                } catch (e) {
                    library = [];
                }
            }
        }

        function saveLibrary() {
            localStorage.setItem('gamen-library', JSON.stringify(library));
            renderLibrary();
        }

        function generateTitle(jsonStory) {
            if (jsonStory.length > 0 && jsonStory[0].jp) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = jsonStory[0].jp;
                const rubyElements = tempDiv.querySelectorAll('rt');
                rubyElements.forEach(rt => rt.remove());
                let title = tempDiv.textContent.substring(0, 30);
                if(tempDiv.textContent.length > 30) title += "...";
                return title;
            }
            return "Untitled Story";
        }

        function deleteStory(id, event) {
            event.stopPropagation(); 
            if (confirm("Delete this story?")) {
                library = library.filter(story => story.id !== id);
                saveLibrary();
            }
        }

        function renderLibrary() {
            libraryList.innerHTML = '';
            
            if (library.length === 0) {
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
                
                // Add index for staggered animation
                library.slice().reverse().forEach((item, index) => {
                    const card = document.createElement('div');
                    card.className = "library-item ripple-btn theme-bg-surface p-4 rounded-2xl border theme-border flex justify-between items-center cursor-pointer hover:bg-opacity-80";
                    // Stagger delay calculation (0s, 0.05s, 0.1s...)
                    card.style.animationDelay = `${index * 0.05}s`;
                    
                    card.onclick = (e) => {
                        createRipple(e);
                        // Small delay to let ripple show before navigating
                        setTimeout(() => loadStoryFromLibrary(item.id), 200);
                    };

                    const dateObj = new Date(item.id);
                    const dateStr = dateObj.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
                    const timeStr = dateObj.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });

                    const leftContent = document.createElement('div');
                    leftContent.className = "flex items-center gap-4 pointer-events-none";

                    const iconDiv = document.createElement('div');
                    iconDiv.className = "p-3 rounded-xl bg-violet-600/20 text-violet-500 flex-shrink-0";
                    iconDiv.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                        </svg>
                    `;

                    const textInfo = document.createElement('div');
                    const titleDiv = document.createElement('div');
                    titleDiv.className = "text-lg font-semibold theme-text-main leading-tight";
                    titleDiv.textContent = item.title || "Untitled";

                    const dateDiv = document.createElement('div');
                    dateDiv.className = "text-xs theme-text-muted mt-1";
                    dateDiv.textContent = `${dateStr} • ${timeStr}`;

                    textInfo.appendChild(titleDiv);
                    textInfo.appendChild(dateDiv);

                    leftContent.appendChild(iconDiv);
                    leftContent.appendChild(textInfo);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = "theme-text-muted hover:text-red-400 p-2 transition-colors flex-shrink-0 z-10";
                    deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>`;
                    deleteBtn.onclick = (e) => deleteStory(item.id, e);

                    card.appendChild(leftContent);
                    card.appendChild(deleteBtn);
                    libraryList.appendChild(card);
                });
            }
        }

        function loadStoryFromLibrary(id) {
            const story = library.find(s => s.id === id);
            if (story) {
                storyData = story.content;
                currentSentenceIndex = 0;
                isMeaningVisible = true;
                
                toggleMeaningButton.classList.remove('toggled');
                meaningContainer.classList.remove('hidden');
                
                history.pushState({page: 'reader', storyId: id}, '', '#read');
                renderPage('reader');
            }
        }

        // --- Existing Reader Logic ---

        function showMessage(text) {
            messageText.textContent = text;
            messageBox.classList.remove('hidden');
            // Allow reflow
            void messageBox.offsetWidth;
        }

        function closeMessage() {
            messageBox.classList.add('hidden');
        }

        function speak(text, lang) {
            if (!'speechSynthesis' in window) {
                showMessage("Your browser does not support Text-to-Speech.");
                return;
            }
            if (window.speechSynthesis.speaking) {
                window.speechSynthesis.cancel();
            } else {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = lang;
                window.speechSynthesis.speak(utterance);
            }
        }
        
        function renderSentence() {
            if (storyData.length === 0) return;
            const sentence = storyData[currentSentenceIndex];

            japaneseText.onclick = null;
            englishText.onclick = null;

            japaneseText.innerHTML = sentence.jp;
            englishText.textContent = sentence.en;

            japaneseText.onclick = () => {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = sentence.jp;
                const rubyElements = tempDiv.querySelectorAll('rt');
                rubyElements.forEach(rt => rt.remove());
                const plainText = tempDiv.textContent;
                speak(plainText, 'ja-JP');
            };

            englishText.onclick = () => {
                speak(sentence.en, 'en-GB'); 
            };

            prevButton.disabled = currentSentenceIndex === 0;
            nextButton.disabled = currentSentenceIndex === storyData.length - 1;
        }

        function loadAndSaveStory() {
            const input = storyInput.value.trim();
            if (input === "") {
                showMessage("Please paste a story into the text area.");
                return;
            }
            try {
                const parsedData = JSON.parse(input);
                if (Array.isArray(parsedData) && parsedData.every(item => item.jp && item.en)) {
                    
                    const newEntry = {
                        id: Date.now(),
                        title: generateTitle(parsedData),
                        content: parsedData
                    };

                    library.push(newEntry);
                    saveLibrary();
                    loadStoryFromLibrary(newEntry.id);

                } else {
                    showMessage("Invalid JSON format. Please use an array of objects with 'jp' and 'en' keys.");
                }
            } catch (error) {
                showMessage("Could not parse the JSON. Please check your syntax.");
            }
        }

        function copyTextToClipboard(text) {
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = text;
            tempTextArea.style.position = 'fixed';
            tempTextArea.style.left = '-9999px';
            document.body.appendChild(tempTextArea);
            tempTextArea.focus();
            tempTextArea.select();
            
            let success = false;
            try {
                success = document.execCommand('copy');
            } catch (err) {
                success = false;
            }
            document.body.removeChild(tempTextArea);

            if (success) {
                const originalText = copyPromptButton.innerText;
                copyPromptButton.innerText = "Copied!";
                copyPromptButton.classList.remove('btn-copy-default');
                copyPromptButton.classList.add('btn-copy-success');
                
                setTimeout(() => {
                    copyPromptButton.innerText = originalText;
                    copyPromptButton.classList.remove('btn-copy-success');
                    copyPromptButton.classList.add('btn-copy-default');
                }, 2000);
            } else {
                showMessage("Failed to copy prompt.");
            }
        }

        // --- Event Listeners ---

        addNewButton.addEventListener('click', goToInput);
        cancelInputButton.addEventListener('click', goHome);
        loadButton.addEventListener('click', loadAndSaveStory);
        copyPromptButton.addEventListener('click', () => copyTextToClipboard(promptText));
        
        backButton.addEventListener('click', goHome); 

        nextButton.addEventListener('click', () => {
            if (currentSentenceIndex < storyData.length - 1) {
                currentSentenceIndex++;
                renderSentence();
            }
        });

        prevButton.addEventListener('click', () => {
            if (currentSentenceIndex > 0) {
                currentSentenceIndex--;
                renderSentence();
            }
        });

        toggleMeaningButton.addEventListener('click', () => {
            isMeaningVisible = !isMeaningVisible;
            if (isMeaningVisible) {
                meaningContainer.classList.remove('hidden');
                toggleMeaningButton.classList.remove('toggled');
            } else {
                meaningContainer.classList.add('hidden');
                toggleMeaningButton.classList.add('toggled');
            }
        });

        closeMessageButton.addEventListener('click', closeMessage);

    </script>
</body>
</html>